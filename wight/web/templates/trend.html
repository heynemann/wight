{% extends "base.html" %}

{% block title %}
    {% if results %}
        Trend for project {{ project }} - {{ full_name }} - Wight v0.1.0
    {% else %}
        Test Result for team {{ team }}, project {{ project }} and test {{ full_name }} not found - Wight v0.1.0
    {% end %}
{% end %}

{% block contents %}
<div class="trend container">
{% if results %}
    <div class="hero-unit">
        <h1>{{ project }}</h1>
        <p>Trend results for {{ full_name }}</p>
        <p><small>This report details the trend results for the last {{ len(results) }} bench runs for the <span class="text-info">{{ project }}</span> project, running the <span class="text-info">{{ full_name }}</span> test.</small></p>
        <div class="toolbar">
            <div><a href="/trend/{{ team }}/{{ project }}/{{ module }}/{{ class_name }}/{{ test }}"><i class="icon-file"></i>Permalink for this test</a></div>
            <div><a href="/report/{{ results[-1]["uuid"] }}"><i class="icon-circle-arrow-left"></i>Last test report for this trend</a></div>
        </div>
    </div>

    <div class="row">
        <div class="page-header">
          <h1>Trends <small>trends for apdex, pages per second and average response time</small></h1>
        </div>

        <h3>Apdex</h3>
        <div class="text-center">
            <div class="btn-group apdex-cycles">
              <button data-cycles="20" class="btn">20 Users</button>
              <button data-cycles="40" class="btn">40 Users</button>
              <button data-cycles="60" class="btn">60 Users</button>
              <button data-cycles="80" class="btn">80 Users</button>
              <button data-cycles="100" class="btn">100 Users</button>
              <button data-cycles="120" class="btn">120 Users</button>
              <button data-cycles="140" class="btn active">140 Users</button>
            </div>
        </div>
        <div class="chart apdex"><svg></svg></div>
        <p class="legend"><small><i>apdex ranges from 0.0 to 1.0, with 1.0 being a perfect score</i></small></p>

        <h3>Pages per second</h3>
        <div class="chart pps"><svg></svg></div>

        <h3>Average response time</h3>
        <div class="chart response-time"><svg></svg></div>
    </div>

    <div class="row">
        <div class="page-header">
          <h1>List of Reports <small>all the reports considered for this trend report</small></h1>
        </div>

        <div class="report-list">
            {% for index, result in enumerate(results) %}
            <a href="/report/{{ result["uuid"] }}">{{ "%02d" % (index + 1) }} - Report for {{ format_date(result["created"]) }}</a>
            {% end %}
        </div>

    </div>


    <p class="text-center"><small>Report generated at {{ report_date }}.</small></p>
{% else %}
    <div class="hero-unit">
        <h1>No load test found</h1>
        <p>We are unable to find a test result for team {{ team }}, project {{ project }} and test {{ full_name }}.</p>
    </div>
{% end %}
</div>
{% end %}

{% block scripts %}
<script>
var floatFormat = function(num) {
    return Math.round(num * 100) / 100;
};


/* START OF APDEX CHART */

var getData = function() {
    var apdexData = [
        {
            key: "0.0-0.2",
            values: [],
            color: "#ca0000"
        },
        {
            key: "0.2-0.4",
            values: [],
            color: "#c04c74"
        },
        {
            key: "0.4-0.6",
            values: [],
            color: "#ff7f00"
        },
        {
            key: "0.6-0.8",
            values: [],
            color: "#5c8800"
        },
        {
            key: "0.8-1.0",
            values: [],
            color: "#87b169"
        }
    ];

    for (var i=0; i < 5; i++) {
        for (var test=0; test < 50; test++) {
            apdexData[i].values.push({
                x: test,
                y: Math.random()
            })
        }
    }

    return apdexData;
};

apdexData = {
    20: getData(20),
    40: getData(40),
    60: getData(60),
    80: getData(80),
    100: getData(100),
    120: getData(120),
    140: getData(140)
};

var apdexChart = null;
nv.addGraph(function() {
    apdexChart = nv.models.stackedAreaChart()
                          .x(function(d) { return d.x })
                          .y(function(d) { return d.y })
                          .showControls(false)
                          .style('expand')
                          .clipEdge(true);

    apdexChart.margin({
        left: 100,
        bottom: 80
    });

    apdexChart.xAxis
              .axisLabel("Bench")
              .tickFormat(function(d) { return "Test #" + d; })
              .showMaxMin(false);

    apdexChart.yAxis
              .tickFormat(function(d) { return floatFormat(d * 100) + "%"; });

    d3.select('.apdex svg')
      .datum(apdexData[140])
      .transition().duration(500).call(apdexChart);

    return apdexChart;
});

var buttons = $('.apdex-cycles .btn');

$('.apdex-cycles .btn').on('click', function(ev) {
    var target = $(ev.currentTarget);

    buttons.removeClass('active');
    target.addClass('active');

    var cycles = target.attr('data-cycles');

    d3.select('.apdex svg')
      .datum(apdexData[parseInt(cycles, 10)])
      .call(apdexChart);
});

/* END OF APDEX CHART */

var concurrentUsers = {{ concurrent_users }};
var testsQuantity = {{ len(results) }};
var ppsValues = [
    {% for result in results %}
        [{% for cycle in result["cycles"] %}
        {{ cycle["page"]["successfulPagesPerSecond"] }},
        {% end %}],
    {% end %}
];

var responseTimeValues = [
    {% for result in results %}
        [{% for cycle in result["cycles"] %}
        {{ cycle["page"]["average"] }},
        {% end %}],
    {% end %}
];
</script>
<script src="{{ static_url('js/trend.js') }}"></script>
{% end %}
